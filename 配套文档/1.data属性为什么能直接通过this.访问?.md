


# Vue å®ä¾‹åŒ–çš„æµç¨‹å›¾
> è¿™æ˜¯æˆ‘è‡ªå·±å†™çš„ä¸€ä»½å…³äº**Vueçš„æµç¨‹å›¾ç¬”è®°**, èƒ½å¤Ÿéå¸¸ç›´è§‚æ–¹ä¾¿çš„äº†è§£æ•´ä¸ªå®ä¾‹åŒ–åšçš„äº‹æƒ…. å¹¶ä¸”è¿™å¼ å›¾å·²ç»æ”¾åœ¨æˆ‘çš„Vueæºç é¡¹ç›®[vue-core-analyse](https://github.com/LinkSofuny/vue-core-analyse), å¹¶ä¸”è¿™ä¸ªé¡¹ç›®çš„æºç æœ‰æˆ‘ä¸ªäººè¯»æºç æ—¶çš„å¤‡æ³¨, ç›¸ä¿¡å¯¹ä½ ä¹Ÿä¼šæœ‰ä¸€å®šçš„å¸®åŠ©ğŸ˜, æ¬¢è¿starâœ¨

è¿™ä¸ªå›¾æ¶µç›–äº†æ•´ä¸ªVueå®ä¾‹æ•°æ®ä¸ç»„ä»¶å®ä¾‹åŒ–çš„æµç¨‹
![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea13b98c938c4fcf8c45d4ba659c9187~tplv-k3u1fbpfcp-watermark.image?)

- è¿™ä¸ªæµç¨‹å›¾æ˜¯vscodeæ’ä»¶`Draw.io Integration`æä¾›çš„, ä½ éœ€è¦ä¸‹è½½æœ¬æ’ä»¶æ‰èƒ½å¯ç”¨

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63db239808f94cdd9ed3e3f14ac0b223~tplv-k3u1fbpfcp-watermark.image?)

# åœºæ™¯
> ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥é€šè¿‡ `this.message` çš„å½¢å¼å»è®¿é—®åˆ°dataå‡½æ•°ä¸­çš„å€¼? 
```js
<script src="../../dist/vue.js"></script>
<script>
  var vm = new Vue({
    el: '#el',
    data () {
        return {
            message: "Hello Vue"
        }
    },
    mounted() {
        const message = this.message
    }
  })
</script>
```

åœ¨æˆ‘ä»¬çœ‹æ¥, ä¼¼ä¹`mouted` å’Œ `data` æ˜¯ä¸¤ä¸ªä¸åŒçš„ä½œç”¨åŸŸ, æˆ‘ä»¬åº”è¯¥å…ˆè®¿é—®å…±åŒçš„ä½œç”¨åŸŸ, ç„¶åå†å»è®¿é—®è¿™ä¸ª`data`å¯¹è±¡æ‰åˆç†ğŸ¤”, å°±åƒè¿™æ ·
```js
mounted() {
    const message = this.data.message
}
```
# åŸç†
> å®é™…ä¸Šè¿™ä¸ªå¤„ç†ä¹Ÿå¾ˆå¥½ç†è§£, æˆ‘ä»¬ä¸€èµ·ä»å…¥å£æ¥çœ‹ä¸€ä¸‹ `Vue` å¯¹ `data` å±æ€§çš„å¤„ç†

`_initå‡½æ•°`æ˜¯åœ¨Vueè¿™æ•´ä¸ªé¡¹ç›®åˆå§‹åŒ–çš„æ—¶å€™é€šè¿‡`initMixin(Vue)`æŒ‚è½½ä¸Šå»çš„, å½“æˆ‘ä»¬ `new Vue({})`çš„æ—¶å€™ä¼šæ‰§è¡Œä¸‹é¢è¿™ä¸ªå‡½æ•°, è¿™ä¸ª`options`, å°±æ˜¯ä¸Šé¢é‚£ä¸ªdemoä¸­æˆ‘ä»¬ä¼ ç»™` Vue æ„é€ å‡½æ•°`çš„å¤§å¯¹è±¡, é‡Œé¢æœ‰`data`, `mounted`ç­‰é…ç½®

```js
// src/core/instance/index.js
function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &&
    // è¦æ±‚ new æ‰§è¡Œ
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options) // ğŸ‘ˆ
}
```
- åœ¨ Vue ä¸­çš„æœ€åä¸€è¡Œæ‰§è¡Œäº†ä¸€ä¸ª `this._init(options)` å‡½æ•°å°±æ˜¯Vueåœ¨è¢«å®ä¾‹åŒ–çš„æ—¶å€™è§¦å‘ä¸€ç³»åˆ—è¡Œä¸º
è¿™é‡Œæˆ‘å¯¹æºç è¿›è¡Œçš„åˆ å‡, æˆ‘ä»¬åªå…³æ³¨`data`éƒ¨åˆ†çš„åˆå§‹åŒ–. è¿™æ ·çš„ä¸€ä¸ª`_init` å‡½æ•° åšäº†ä¸€ä¸‹å‡ ä»¶äº‹æƒ…
1. å®šä¹‰ä¸€ä¸ª`vm`ç­‰äºå½“å‰å®ä¾‹
2. åˆæ­¥æŒ‚è½½`$options`å¹¶åˆå¹¶é…ç½®é€‰é¡¹

    è¿™é‡Œæˆ‘ä»¬å…ˆç®€å•çš„ç†è§£ä¸º `vm.$options = options`
3. æ‰§è¡Œ`initState(vm)`åˆå§‹åŒ–å…¨éƒ¨çŠ¶æ€
> **æ­¥éª¤3**æ˜¯æˆ‘ä»¬æœ€éœ€è¦å…³æ³¨çš„. åœ¨è¿™ä¸ªå‡½æ•°ä¸­è´Ÿè´£åˆå§‹åŒ–é…ç½®é¡¹ä¸­çš„ `props` `methods` `data`ç­‰å±æ€§
```js
// src/core/intance/init.js
Vue.prototype._init = function (options?: Object) {
    const vm: Component = this
    
    // a flag to avoid this being observed
    vm._isVue = true
    
    // merge options
    vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
    )
    // expose real self
    vm._self = vm
    
    // åˆå§‹åŒ–çŠ¶æ€
    initState(vm)
  }
```
- è¿™ä¸ªå‡½æ•°è¿™é‡Œä¹Ÿå°±åˆ°äº†æˆ‘ä»¬çš„**ç»ˆæç›®æ ‡**`initData(vm)`åœ¨è¿™é‡Œè´Ÿè´£åˆå§‹æˆ‘ä»¬çš„æ•°æ®(data)
```js
// src/core/intance/state.js
// åˆå§‹åŒ–çŠ¶æ€
export function initState (vm: Component) {
  const opts = vm.$options
  // åŸºäºæˆ‘ä»¬optionsä¸­å­˜åœ¨çš„å±æ€§è¿›è¡Œåˆå§‹åŒ–
  if (opts.data) {
    // åˆå§‹åŒ–æ•°æ®
    initData(vm)
  }
  
}

```
1. `initDataå‡½æ•°`é¦–å…ˆä¼šåˆ¤æ–­æˆ‘ä»¬çš„`data`æ˜¯å¦ä¸ºä¸€ä¸ªå‡½æ•°, æ˜¯çš„è¯æ‰§è¡Œä»–å¹¶è¿”å›ä¸€ä¸ªå¯¹è±¡. å¦‚æœä¸æ˜¯åˆ™ç›´æ¥ä½¿ç”¨.
2. whileå¾ªç¯é¦–å…ˆå¯¹æˆ‘ä»¬çš„`data`ä¸`pros`å’Œ`method`åšä¸€å±‚é‡åæ ¡éªŒ, è¿™é‡Œçš„é€»è¾‘ååˆ†ç®€å•. æˆ‘ä»¬æ— éœ€å…³æ³¨
3. å°†è¿™ä¸ªå¯¹è±¡èµ‹å€¼ä¸€ä»½ç»™ `data` å’Œ `vm._data`
4. ç„¶åè°ƒç”¨ proxy(vm, _data, key)
```js
// src\core\instance\state.js
function initData (vm: Component) {
  let data = vm.$options.data
  data = vm._data = typeof data === 'function'
    ? getData(data, vm)
    : data || {}
    
  const keys = Object.keys(data)
  const props = vm.$options.props
  const methods = vm.$options.methods
  let i = keys.length
  while (i--) {
    const key = keys[i]
    /**
     * å¯¹dataä¸­çš„keyä¸ props å’Œ method åšå¯¹æ¯”, è¦æ±‚ä¸èƒ½å¤Ÿ key é‡å¤
     */
    if (process.env.NODE_ENV !== 'production') {
      //..
    }
    if (props && hasOwn(props, key)) {
      //...
    } else if (!isReserved(key)) {
      // ä»£ç†
      proxy(vm, `_data`, key) // ğŸ‘ˆ
    }
  }
}
```

**é‡ç‚¹åœ¨äºproxy(vm, `_data`, key)**

1. proxyå‡½æ•°é¦–å…ˆä¸º`sharedPropertyDefinition`å¯¹è±¡å®šä¹‰äº†ä¸€ä¸ª`get`å’Œ`set`æ–¹æ³•
2. é€šè¿‡[defineProperty](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)å»å¯¹vmå¯¹è±¡åšæ‹¦æˆªæ“ä½œ

> ä¹Ÿå°±æ˜¯è¯´ å½“æˆ‘ä»¬é€šè¿‡ `vm` ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ `this.message` çš„å½¢å¼ å»è®¿é—®æ•°æ®æ—¶å€™, ä¼šé€šè¿‡`defineProperty`å‡½æ•°åšçš„æ‹¦æˆªæ“ä½œå°† `this._data.message` è½¬å‘ç»™æˆ‘ä»¬(èµ‹å€¼åŒç†)

```js
// \src\core\instance\state.js
export function proxy (target: Object, sourceKey: string, key: string) {
  sharedPropertyDefinition.get = function proxyGetter () {
    return this[sourceKey][key]
  }
  sharedPropertyDefinition.set = function proxySetter (val) {
    this[sourceKey][key] = val
  }
  /**
   * ä¸ºä»€ä¹ˆ åœ¨å…¶ä»–å±æ€§é‡Œ, å¯ä»¥ç›´æ¥é€šè¿‡ this.message å°±èƒ½æ‹¿åˆ° data ä¸­çš„å€¼?
   *  ç­”æ¡ˆå°±åœ¨è¿™é‡Œ, vue åœ¨ åˆå§‹åŒ– data çš„æ—¶å€™ä¼šé€šè¿‡è¿™ä¸ªä»£ç†å‡½æ•°
   *  å°† data ä¸­çš„ key å€¼ç›´æ¥æ”¾åˆ° vm å®ä¾‹ä¸Šè¿›è¡Œç›‘æ§,ç„¶ååŸºäºä¸Šé¢çš„å¯¹è±¡è¿›è¡Œç›‘æ§
   *  è®¿é—® this.message ç›¸å½“äºè®¿é—®äº† this._data.message
  */
  Object.defineProperty(target, key, sharedPropertyDefinition)
}
```
## æµç¨‹å›¾å±•ç¤º

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/009fa194830e4a0e8b200bf518b3e236~tplv-k3u1fbpfcp-watermark.image?)

```js
new Vue({
    el: '#app',
    data:{
      msg: 'parent-Vue'
    },
    mounted () {
      console.log(this.msg);
      console.log(this._data.msg); // å½“ç„¶å¹¶ä¸æ¨èé€šè¿‡è¿™ç§æ–¹å¼è®¿é—®æ•°æ®
    }
})
```
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62a888d5d5c645259d16e993a8bcbe1c~tplv-k3u1fbpfcp-watermark.image?)




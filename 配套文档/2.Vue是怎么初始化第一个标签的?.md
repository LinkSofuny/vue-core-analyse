è®²å®Œäº†`data`, è¿™æœŸæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€ä¸ªåŸç”ŸèŠ‚ç‚¹æ˜¯æ€ä¹ˆæŒ‚è½½çš„. ä¹Ÿå°±æ˜¯æˆ‘ä»¬å°é¢çš„è¿™ä¸ªèŠ‚ç‚¹.


## æµç¨‹å›¾
> è¿™æ˜¯æœ¬æ–‡å†…å®¹çš„æ€»å›¾, å¯ä»¥å¯¹ç…§è¿™ä¸ªå›¾çœ‹æ–‡ç« , å¦‚æœè¿™é‡Œçœ‹ä¸æ¸…æ¥šçš„è¯, å¯ä»¥åˆ°æˆ‘çš„æºç é¡¹ç›®[vue-core-analyse](https://github.com/LinkSofuny/vue-core-analyse)è‡ªè¡Œä¸‹è½½,**æ¬¢è¿starå“¦**~âœ¨

![VueåŸç”ŸèŠ‚ç‚¹çš„æŒ‚è½½.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7f9f74011e14137b766309408db4c94~tplv-k3u1fbpfcp-watermark.image?)

## åˆå§‹åŒ–å‡½æ•°
> åœ¨æˆ‘ä»¬æ‰€æœ‰çš„`data`, `props`ç­‰çŠ¶æ€åˆå§‹å®Œæ¯•å, _initå‡½æ•°æœ€ç»ˆä¼šæ‰§è¡Œä¸€ä¸ª`$mountå‡½æ•°`
```js
// /src/core/instance/init.js
Vue.prototype._init = function (options?: Object) {
    const vm: Component = this
    // a uid
    vm._uid = uid++

    // ç”¨äºæ ‡è¯†å½“å‰çš„å®ä¾‹æ˜¯ Vue å®ä¾‹
    vm._isVue = true
    // åˆå¹¶é…ç½®é¡¹
    if (options && options._isComponent) {
      initInternalComponent(vm, options)
    } else {
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
    // expose real self
    vm._self = vm
    initLifecycle(vm)
    initEvents(vm)
    initRender(vm)
    callHook(vm, 'beforeCreate') // ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    initInjections(vm)
    initState(vm) // è¿™é‡Œå°±æ˜¯æˆ‘ä»¬ä¸ŠæœŸè®²çš„ data ç­‰å±æ€§çš„åˆå§‹åŒ–å¤„
    initProvide(vm)
    callHook(vm, 'created')
    
    // ---------- åœ¨æ‰€æœ‰å±æ€§åˆå§‹åŒ–å®Œæ¯•å, æˆ‘ä»¬å¼€å§‹æŒ‚è½½èŠ‚ç‚¹
    if (vm.$options.el) {
      vm.$mount(vm.$options.el) // ğŸ‘ˆ è¿™é‡Œæ˜¯æˆ‘ä»¬æœ¬æœŸçš„å…³æ³¨ç‚¹
    }

```

## ç¼–è¯‘ç‰ˆæœ¬çš„åŒºåˆ«
> ç¼–è¯‘ç‰ˆæœ¬çš„ä¸åŒ, ä¼šè®©Vueåœ¨èŠ‚ç‚¹çš„æŒ‚è½½ä¸Šåšçš„äº‹æƒ…æœ‰äº›ä¸åŒ, æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„å¼‚åŒ

`Vue-cli3` è„šæ‰‹æ¶åœ¨æˆ‘ä»¬ç”Ÿæˆé¡¹ç›®çš„æ—¶å€™, å°±ä¼šæä¾›è¿™æ ·çš„é€‰æ‹©, æç¤ºæˆ‘ä»¬éœ€è¦é€‰æ‹©å“ªä¸ªç‰ˆæœ¬çš„Vue, è¿™é‡Œå¯ä»¥è¿™æ ·æ€»ç»“:

- `runtime-with-complier` ç‰ˆæœ¬: æ˜¯ä¸€ä¸ªå®Œæ•´ç‰ˆçš„`Vue`, å®ƒèƒ½å¤Ÿæä¾›ä»æ¨¡æ¿(template) => çœŸå®dom çš„ç”Ÿæˆæ‰€éœ€çš„å…¨éƒ¨åŠŸèƒ½, ä¸€èˆ¬æºç è°ƒè¯•æˆ‘ä»¬é€‰æ‹©è¿™ä¸ªç‰ˆæœ¬.

- `runtime-only` ç‰ˆæœ¬: å°†ç¼–è¯‘éƒ¨åˆ†çš„å·¥ä½œæŠ½ç¦»äº†å‡ºæ¥, ä½œä¸ºä¸€ä¸ª `vue-loader` å»å•ç‹¬å·¥ä½œ. è¿™æ ·èƒ½å¤Ÿç¼©å‡vueçš„å¤§å°, åœ¨æ€§èƒ½ä¸Šä¹Ÿä¼šæ›´å¥½, æ‰€ä»¥ä¸šåŠ¡å¼€å‘æˆ‘ä»¬é€šå¸¸éƒ½æ˜¯é€‰æ‹©è¿™ä¸ªç‰ˆæœ¬.

### runtime-with-complier
> æ‰§è¡Œæµç¨‹: template => ast(æŠ½è±¡è¯­æ³•æ ‘) => ç”Ÿæˆrender() => ç”ŸæˆVDom => çœŸå®Dom

```js
new Vue({
    template: '<div id="app"> Hello Vue <div>'
}).$mount('#app')
```

åœ¨è¿™ä¸ªç‰ˆæœ¬çš„Vueä¸­, å½“é¡¹ç›®è¿è¡Œæ—¶, ä¹Ÿå°±æ˜¯`runtime`é˜¶æ®µ, Vueéœ€è¦è‡ªè¡Œå®Œæˆä¸Šè¿°æµç¨‹çš„ç¼–è¯‘, è¿™æ ·æ˜¾ç„¶è¿è¡Œéœ€è¦çš„æ—¶é—´å°±æ›´å¤šäº†.

### runtime-only
>  ç”ŸæˆVDom => çœŸå®Dom
```js
src
â”œâ”€ App.vue
â””â”€ main.js
```
```js
new Vue({
  render: h => h(App),
}).$mount('#app')
```

- `only`å°† `App.vue` è½¬æ¢æˆ `renderå‡½æ•°`çš„è¿‡ç¨‹å‘ç”Ÿåœ¨æ„å»ºé˜¶æ®µ, ä¹Ÿå°±æ˜¯è¿™äº›å·¥ä½œç”± `Vue-Loader` å®Œæˆ.

> ä¸éš¾çœ‹å‡ºä»ä¸šåŠ¡çš„è§’åº¦å‡ºå‘, `only`ç‰ˆæœ¬çš„æ€§èƒ½æ›´åŠ ä¼˜è¶Š, å› ä¸ºåœ¨ runtime çš„æ—¶å€™éœ€è¦åšçš„äº‹æƒ…å˜å°‘äº†. æ¨¡æ¿ç¼–è¯‘å·¥ä½œ, æˆ‘ä»¬å¯ä»¥åœ¨`æ„å»ºé˜¶æ®µ`(ä¸¢ç»™webpackå»åš)å°±å®Œæˆäº†


## $mount å‡½æ•°
> ä»¥ä¸‹æ˜¯ä¸¤ä¸ªç‰ˆæœ¬çš„`$mountå‡½æ•°`çš„ä¸¤ä¸ªå®šä¹‰å¤„
- æˆ‘ä»¬å…ˆæŠŠè¿™ä¸ª`$mount` ç§°ä¸º `only`ğŸ‘‡
```js
// src/platforms/web/runtime/index.js

Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  // åˆ¤æ–­ æ˜¯ä¸æ˜¯ dom
  el = el && inBrowser ? query(el) : undefined
  return mountComponent(this, el, hydrating)
}
```
- æŠŠè¿™ä¸ª`$mount` ç§°ä¸º `compiler`ğŸ‘‡
```js
// /src/platforms/web/entry-runtime-with-compiler.js

// å°†åŸå…ˆçš„ mount æ‹¿å‡ºæ¥
const mount = Vue.prototype.$mount
// å®šä¹‰ä¸€ä¸ªæ–°çš„, ç”±äºåœ¨ runtime-compiler ç‰ˆæœ¬æˆ‘ä»¬éœ€è¦åšé¢å¤–çš„å¤„ç†
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  // å°† el å±æ€§ è½¬åŒ–ä¸º dom å¯¹è±¡
  el = el && query(el)
  if(template) {

      // ç¼–è¯‘å·¥ä½œåœ¨è¿™é‡Œæ‰§è¡Œ, æœ€åä¼šç”Ÿæˆä¸€ä¸ªrenderå‡½æ•°èµ‹å€¼ç»™ this.$options
      // ç›®å‰å…ˆç†è§£ä¸º èµ°è¿‡è¿™ä¸€æ­¥, æˆ‘ä»¬å°±æœ‰ render å‡½æ•°äº†
      
  }
  return mount.call(this, el, hydrating) // è¿™é‡Œæ‰§è¡Œ
}
```
- è¿™é‡ŒVueåšäº†ä»€ä¹ˆäº‹æƒ…å‘¢?
å…¶å®å¾ˆç®€å•, é¦–å…ˆå®šä¹‰`only`, ç„¶ååœ¨ `entry-runtime-with-compiler.js` ä¸­æŠŠ `only` æ‹¿å‡ºæ¥ä¿å­˜åœ¨å˜é‡ `mount` ä¸­. ç„¶å`complier`çš„æœ€å `return` çš„æ—¶å€™ åšä¸€ä¸ªå°¾å›è°ƒæ‰§è¡Œ `only`


- æ¢³ç†å®Œä»–ä»¬ä¸¤è€…çš„åŒºåˆ«, æˆ‘ä»¬å°±æ¥çœ‹çœ‹ä»–ä»¬ç©¶ç«Ÿåšäº†ä»€ä¹ˆäº‹æƒ…. æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æµç¨‹å›¾, è¿™é‡Œè“è‰²éƒ¨åˆ†æ˜¯`complier`çš„`$mountå‡½æ•°`åšçš„äº‹æƒ…, è€Œçº¢è‰²éƒ¨åˆ†æ˜¯`only`ç‰ˆæœ¬`$mountå‡½æ•°`åšçš„äº‹æƒ….

![æˆªå±2021-12-22 ä¸Šåˆ11.34.01.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c69a4e5168f04738a9726508c2d057ff~tplv-k3u1fbpfcp-watermark.image?)

---




## ç»„ä»¶æŒ‚è½½
> é‚£ä¹ˆæ¥ä¸‹æ¥, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`mountComponent`å‡½æ•°åšäº†å“ªäº›äº‹æƒ….


![æˆªå±2021-12-22 ä¸‹åˆ4.59.17.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23bbdd984e544413ae0b4cd2ca09fe9a~tplv-k3u1fbpfcp-watermark.image?)

```js
export function mountComponent (
  vm: Component,
  el: ?Element,
  hydrating?: boolean
): Component {
  // æŒ‚è½½ dom
  vm.$el = el
  
  // vue åˆå§‹åŒ–çš„æ—¶å€™,æ— è®ºæ˜¯templateè¿˜æ˜¯ render æœ€ç»ˆéƒ½ä¼šè½¬åŒ–ä¸º renderå‡½æ•° è¿›è¡Œæ¸²æŸ“
  if (!vm.options.render) { /* å¦‚æœåˆ°è¿™é‡Œäº†è¿˜æ²¡æœ‰ render å‡½æ•° é‚£å°±ä¼šæŠ¥é”™äº† */ }
  // å‘¨æœŸé’©å­
  callHook(vm, 'beforeMount') // beforeMount å°±æ˜¯åœ¨è¿™ä¸ªèŠ‚ç‚¹è§¦å‘çš„

  let updateComponent
  // åˆ›å»º updateComponent å‡½æ•°, ä¹‹åæ›´æ–°æ•°æ® updateComponent ä¼šè¢«è§¦å‘æ‰§è¡Œ
  updateComponent = () => {
    vm._update(vm._render(), hydrating)
  }
  
  // åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿè€…å®ä¾‹
  vm._watcher = new Watcher(vm, updateComponent, noop)

  return vm
}
```
**è¿™ä¸ªå‡½æ•°åšäº†ä¸¤ä»¶äº‹æƒ…:**

1. å®šä¹‰äº†ä¸€ä¸ª `updateComponent`

2. åˆ›å»ºäº†ä¸€ä¸ªè§‚å¯Ÿè€…å®ä¾‹ `Watcher`, å¹¶ä¼ å…¥ `updateComponent`

è¿™é‡Œä½ å¯ä»¥ç†è§£ä¸º, Vue æŒ‚è½½äº†ç¬¬ä¸€ä¸ªç»„ä»¶, å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ `new Vue()` æœ¬è´¨ä¸Šå®ƒä¹Ÿæ˜¯ä¸€ä¸ªç»„ä»¶. ä¹Ÿå°±æ˜¯è¯´, æ¯ä¸€æ¬¡æˆ‘ä»¬åˆ›å»ºç»„ä»¶, å°±æ˜¯åœ¨å®ä¾‹åŒ–ä¸€ä¸ªVue, å¹¶ä¸”åˆ›å»ºä¸€ä¸ª `watcher`


> è¿™é‡Œæˆ‘ä»¬å…ˆä¸å»ç†è§£**è§‚å¯Ÿè€…å®ä¾‹**å†…éƒ¨çš„é€»è¾‘, åªéœ€è¦çŸ¥é“å‘ç”Ÿå˜åŒ–çš„æ—¶å€™, åœ¨å®ä¾‹å†…éƒ¨ä¼šå»è°ƒç”¨`updateComponent`

---

**updateComponentå‡½æ•°å†…éƒ¨ä¼šæ‰§è¡Œä¸¤ä¸ªå‡½æ•°:**

1. `vm.render()`: è´Ÿè´£ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹

2. `_update()`: è´Ÿè´£æ›´æ–°æ“ä½œ, å°†è™šæ‹ŸèŠ‚ç‚¹è½¬åŒ–ä¸ºçœŸå®èŠ‚ç‚¹, å¹¶æ’å…¥åˆ°DOMæ ‘ä¸­


æˆ‘ä»¬å…ˆæ¥çœ‹ `vm._render()`å‡½æ•°çš„å·¥ä½œ, ä»–æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ª `vnode` ç»™æˆ‘ä»¬çš„ `_update`

```js
  // /src/core/instance/render.js
  Vue.prototype._render = function (): VNode {
    const vm: Component = this
    const { render } = vm.$options

    let vnode
    try {
      // æ ‡è®°å½“å‰æ¸²æŸ“çš„å®ä¾‹
      currentRenderingInstance = vm
      vnode = render.call(vm._renderProxy, vm.$createElement) // ğŸ‘ˆ æˆ‘ä»¬éœ€è¦å…³æ³¨è¿™é‡Œ
    } catch (e) {
      // ... è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬æ— éœ€å…³æ³¨
    } finally {
      // å–æ¶ˆå½“å‰å®ä¾‹çš„æ ‡è®°
      currentRenderingInstance = null
    }
   
    return vnode
  }
```

> è¯·æ³¨æ„, è¿™ä¸ª`renderå‡½æ•°`, å°±æ˜¯ç”±`vue-loader` æˆ–è€… `Vue` æœ¬èº«ç”Ÿæˆçš„, å½“ç„¶è¿˜æœ‰ä¸€ç§æ–¹å¼, å°±æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„, **ä»–é»˜è®¤ä¼šä¼ å…¥ä¸€ä¸ªå®ä¾‹, è¿˜æœ‰ä¸€ä¸ªå‡½æ•°**, æˆ‘ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´åœ¨æ–‡æ¡£ä¸­ä¹Ÿæœ‰çœ‹åˆ°è¿‡. æˆ‘è¿™é‡ŒæŒ‡ä¸ªè·¯[Vue - æ¸²æŸ“å‡½æ•° & JSX](https://cn.vuejs.org/v2/guide/render-function.html)

**ä¾‹å¦‚:**
```js
  new Vue({
    el: '#app',
    data:{
      msg: 'parent-Vue'
    },
    render: function ($createElement) { // åˆ›å»ºä¸€ä¸ª <div id="foo"></div>
      // è¿™é‡Œå‚æ•°, å°±æ˜¯å¯¹åº”ä¸Šé¢çš„ a, b, c, d
      return $createElement(
        'p',
        { attrs: { id: 'foo' } }, 
        [ h('div', '111') ]
      )
    }
  })
```
ä¹Ÿå°±æ˜¯è¯´åœ¨ `renderå‡½æ•°` å†…éƒ¨, `vm.$createElement` å‡½æ•°ä¼šè¢«é»˜è®¤æ‰§è¡Œ, æˆ‘ä»¬æ¥çœ‹çœ‹å®šä¹‰



- è¿™æ˜¯ `$createElement` ğŸ‘‡ çš„å®šä¹‰, è¿”å›äº†ä¸€ä¸ªé»˜è®¤æ‰§è¡Œçš„`createElement`
```js
vm.$createElement = function (a, b, c, d) { return createElement(vm, a, b, c, d, true); };
```
> `createElement`æœ€ç»ˆä¼šè¿”å›`_createElement`, å…¶å®Vueè¿™ä¹ˆåš, åªä¸è¿‡æ˜¯åœ¨ `createElement`, åšä¸€äº›å‚æ•°çš„å¤„ç†å·¥ä½œ, å› ä¸ºæˆ‘ä»¬çš„`createElement`é…ç½®æ˜¯æ¯”è¾ƒçµæ´»çš„

```js
// /src/core/instance/render.js
var SIMPLE_NORMALIZE = 1;
var ALWAYS_NORMALIZE = 2;
function createElement (
    context,           // å½“å‰å®ä¾‹
    tag,               // æ ‡ç­¾
    data,              // å½“å‰èŠ‚ç‚¹çš„å±æ€§  id ç­‰
    children,          // å­èŠ‚ç‚¹
    normalizationType, // é’ˆå¯¹å­èŠ‚ç‚¹æ“ä½œç±»å‹
    alwaysNormalize    // ç”¨äºçº¦æŸä¸Šä¸€ä¸ªå‚æ•° å…·ä½“çœ‹ä¸‹é¢ä»£ç 
) {
    if (Array.isArray(data) || isPrimitive(data)) {
      normalizationType = children;
      children = data;
      data = undefined;
    }
    // çœ‹å›¾å¯ä»¥çŸ¥é“, alwaysNormalize åœ¨å½“å‰æµç¨‹ä¸‹æ€»æ˜¯è¢«ç½®ä¸º true
    if (isTrue(alwaysNormalize)) {
      // è¿™é‡Œä¸»è¦æ˜¯å¯¹å­èŠ‚ç‚¹åšæ“ä½œä¸åŒçš„æ ‡è¯†
      normalizationType = ALWAYS_NORMALIZE;
    }
    return _createElement(context, tag, data, children, normalizationType)
}
```

ä¸ºäº†é˜²æ­¢å‚æ•°çœ‹èµ·æ¥å¾ˆæ··ä¹±, æˆ‘ä»¬ä»¥ä¸Šé¢é‚£ä¸ªdemoä¸ºä¾‹, ç”»ä¸€ä¸ªå›¾å¯¹ç…§ç€çœ‹ğŸ˜

![æˆªå±2021-12-22 ä¸‹åˆ4.23.20.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c08670eba404748bbb7c1d916854b7f~tplv-k3u1fbpfcp-watermark.image?)

---
## åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹
**_createElement**ä¼šåˆ¤æ–­å½“å‰`tag`æ˜¯å¦ä¸ºä¸€ä¸ª`stringç±»å‹`, æ˜¯çš„è¯ é€šè¿‡`new VNode(tag)`å»æè¿°ä¸€ä¸ªåŸç”ŸèŠ‚ç‚¹, å¦åˆ™å¦‚æœæ˜¯ä¸€ä¸ªç»„ä»¶å°±è¦åšé¢å¤–çš„å¤„ç†

```js
export function _createElement (
  context: Component,
  tag?: string | Class<Component> | Function | Object, // tag ä¹Ÿæœ‰å¯èƒ½æ˜¯ç»„ä»¶, å‡½æ•° ç­‰
  data?: VNodeData,          // è¿™é‡Œçš„data æ˜¯ key id è¿™ç§å®šä¹‰åœ¨æ ‡ç­¾é‡Œçš„å±æ€§
  children?: any,            // å­èŠ‚ç‚¹
  normalizationType?: number // æ“ä½œç±»å‹ç±»å‹
): VNode {
  
  if (isDef(data) && isDef(data.is)) {
    // å­˜åœ¨ is å±æ€§ åˆ™è¯æ˜è¦å°†æŸä¸ªæ ‡ç­¾æŒ‡å®šä¸º is ä¸­çš„è¿™ä¸ªæ ‡ç­¾
    tag = data.is
  }
  
  // é€’å½’å­èŠ‚ç‚¹, è¯·æ³¨æ„æˆ‘ä»¬ä¸Šé¢ demo ä¸­çš„å­èŠ‚ç‚¹æ•°ç»„, å°±æ˜¯åœ¨è¿™ä¸€éƒ¨åˆ†åšäº†æ“ä½œ
  if (normalizationType === ALWAYS_NORMALIZE) {
    children = normalizeChildren(children)
  } else if (normalizationType === SIMPLE_NORMALIZE) {
    children = simpleNormalizeChildren(children)
  }
  
  let vnode, ns
  // æ ‡ç­¾
  if (typeof tag === 'string') {
      // html åŸç”Ÿä¿ç•™æ ‡ç­¾
      // platform built-in elements
      vnode = new VNode(
        // åˆ›å»ºå¹³å°ä¿ç•™æ ‡ç­¾ è¿™é‡Œç†è§£æˆ (tag) => tag å°±å¥½äº†
        config.parsePlatformTagName(tag), data, children,
        undefined, undefined, context
      )  
  } else {
    // direct component options / constructor
    // å¦‚æœæ˜¯ä¸€ä¸ªç»„ä»¶, (è¿™ä¸ªæ˜¯ä¸‹ä¸€ç« èŠ‚çš„å†…å®¹)
    vnode = createComponent(tag, data, context, children)
  }
  return vnode
}
```
**è¿™ä¸ªå‡½æ•°ä¸»è¦åšäº†ä¸‰ä»¶äº‹:**

1. é€šè¿‡ `normalizeChildren` è·å–å­èŠ‚ç‚¹.

      - è¿™é‡Œå®é™…ä¸Šæ˜¯å¯¹å­èŠ‚ç‚¹åšäº†ä¸€äº›ä¼˜åŒ–æ“ä½œ, æ¯”å¦‚ä¸¤ä¸ªç›¸é‚»çš„å­èŠ‚ç‚¹éƒ½æ˜¯æ–‡æœ¬, é‚£å°±åˆå¹¶å®ƒ, ç”±äºä¸æ˜¯æœ¬æ¬¡é‡ç‚¹, æˆ‘ä»¬å°±ä¸ä»‹ç»äº†
 
2. å¦‚æœ `tag` æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² åˆ™åˆ›å»ºä¸€ä¸ª `Vnode`

3. å¦åˆ™åˆ›å»ºä¸€ä¸ªç»„ä»¶


![æˆªå±2021-12-22 ä¸‹åˆ4.59.50.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a46ced7448b949038924b00dd34ba9ba~tplv-k3u1fbpfcp-watermark.image?)

> `new VNode()`å…¶å®å°±æ˜¯ä¸€ä¸ªå¯¹è±¡, ç›¸è¾ƒäºç”¨ä¸€ä¸ªåŸç”Ÿçš„DOMåšä¸ºèŠ‚ç‚¹, VNodeéœ€è¦çš„å†…å­˜è¦å°çš„çš„å¤š, å› ä¸ºDOMä¸Šæœ‰å¾ˆå¤šæˆ‘ä»¬ä¸éœ€è¦çš„å±æ€§

ç”±äº Vnode() çš„å®šä¹‰æ¯”è¾ƒé•¿, ååˆ†å ç”¨ç¯‡å¹…, å¤§å®¶å¯ä»¥é€šè¿‡è¿™é‡Œçœ‹[vnode.js](https://github.com/LinkSofuny/vue-core-analyse/blob/dev/src/core/vdom/vnode.js)



**å¥½çš„, ç›´åˆ°è¿™é‡Œä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„äº§ç”Ÿé€»è¾‘, æˆ‘ä»¬å°±çœ‹å®Œäº†, æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹. ä¸€ä¸ªæ ‡ç­¾æ˜¯æ€æ ·è¢«æŒ‚è½½åˆ°Domæ ‘ä¸Šçš„**

---

## èŠ‚ç‚¹çš„æŒ‚è½½
åœ¨ `vm._update()` ä¸­, å®ƒè´Ÿè´£å°†è¿™ä¸ªèŠ‚ç‚¹è½¬åŒ–ä¸ºçœŸå®çš„DomèŠ‚ç‚¹, å¹¶ä¸”æ’å…¥åˆ°Domæ ‘ä¸Š

```js
  // src/core/instance/lifecycle.js
  Vue.prototype._update = function (vnode: VNode, hydrating?: boolean) {
    const vm: Component = this  // å½“å‰ç»„ä»¶å®ä¾‹
    const prevEl = vm.$el       // ä¸Šä¸ªçœŸå®èŠ‚ç‚¹
    const prevVnode = vm._vnode // å–å‡ºä¸Šä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹(ä¸Šæ¬¡æ›´æ–°), ç¬¬ä¸€æ¬¡çš„æ—¶å€™è¿™é‡Œä¸ºç©º
    vm._vnode = vnode
    
    if (!prevVnode) { // ä¸å­˜åœ¨å‰è™šæ‹ŸèŠ‚ç‚¹è¯æ˜æ˜¯åˆå§‹åŒ–
      // åˆå§‹åŒ–
      vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */)
    } else {
      // æ›´æ–°èŠ‚ç‚¹
      vm.$el = vm.__patch__(prevVnode, vnode)
    }
  }
```
> å…¶ä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å‡½æ•°`vm.__patch__`æ ¹æ®åå­—æˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚çŒœåˆ°å®ƒå¯èƒ½æ˜¯ä¸€ä¸ª"è¡¥ä¸"

**æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ `patchå‡½æ•°` åšäº†å“ªäº›äº‹æƒ…**

1. å°†æ—§çš„èŠ‚ç‚¹è½¬åŒ–ä¸º `ç©ºè™šæ‹ŸèŠ‚ç‚¹` (ä¸ºäº†æ–¹ä¾¿å¸è½½æ—§çš„èŠ‚ç‚¹)
2. `createElm()` åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹
3. diffæ–°æ—§èŠ‚ç‚¹ ( æˆ‘ä»¬ç°åœ¨å¤„äºåˆå§‹åŒ–é˜¶æ®µ, æ˜¾ç„¶è¿™ä¸€æ­¥ä¸ä¼šæ‰§è¡Œ )
4. å¸è½½æ—§èŠ‚ç‚¹

```js
 // /src/core/vdom/patch.js
 return function patch (
     oldVnode,  // æœ¬æµç¨‹ä¸­æ˜¯ vm.$el ä¹Ÿå°±æ˜¯çœŸå®çš„æ ¹èŠ‚ç‚¹
     vnode,     // æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„ vnode
     hydrating, // ç”¨ä¸åˆ°
     removeOnly // ç”¨ä¸åˆ°
 ) {
 
    let isInitialPatch = false
    const insertedVnodeQueue = []

    // å°†çœŸå® dom è½¬åŒ–ä¸º VNode
    oldVnode = emptyNodeAt(oldVnode)
    // oldElm æ˜¯ä¸€ä¸ªçœŸå®èŠ‚ç‚¹
    const oldElm = oldVnode.elm
    // æ‹¿åˆ°å½“å‰domçš„çˆ¶èŠ‚ç‚¹
    const parentElm = nodeOps.parentNode(oldElm)
    
    // ğŸ‘‡ åˆ›å»ºèŠ‚ç‚¹
    createElm(
      vnode,                      // å½“å‰è™šæ‹ŸèŠ‚ç‚¹
      insertedVnodeQueue,         // è¿™é‡Œæ˜¯ç©ºæ•°ç»„
      parentElm,                  // åˆå§‹åŒ–çš„æ—¶å€™ è¿™é‡Œæ˜¯ bodyæ ‡ç­¾
      nodeOps.nextSibling(oldElm) // å…„å¼ŸèŠ‚ç‚¹(æœ€åæ’å…¥çˆ¶å…ƒç´ è¦ç”¨åˆ°)
    )
    
    // æ˜¾ç„¶åˆå§‹åŒ–çš„æ—¶å€™ä¸ä¼šèµ°åˆ°è¿™é‡Œ
    // ğŸ‘‡ æ›´æ–°èŠ‚ç‚¹
    if (isDef(vnode.parent)) { /* è¿™æ˜¯æ›´æ–°é˜¶æ®µåšçš„äº‹æƒ…, diffä¹Ÿåœ¨è¿™é‡Œ */ }
    
    // ğŸ‘‡ åˆ é™¤æ—§èŠ‚ç‚¹
    if (isDef(parentElm)) {
      removeVnodes([oldVnode], 0, 0)
    } else if (isDef(oldVnode.tag)) {
      invokeDestroyHook(oldVnode)
    }

    return vnode.elm
  }
```

![æˆªå±2021-12-22 ä¸‹åˆ6.18.36.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fa4da32388b43928c8428d2e8b5ecfd~tplv-k3u1fbpfcp-watermark.image?)


---

**æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ­¥éª¤2**

`createElm()` é¦–å…ˆ, **ä¼šåˆ¤æ–­å½“å‰è™šæ‹ŸèŠ‚ç‚¹æ˜¯å¦å¯ä»¥ä½œä¸ºä¸€ä¸ªç»„ä»¶è¢«åˆ›å»º**, å†å°†å…¶ä½œä¸ºä¸€ä¸ªæ™®é€šçš„èŠ‚ç‚¹(æ­£å¸¸çš„DOM, æˆ–è€…æ³¨é‡Šä»¥åŠæ–‡æœ¬èŠ‚ç‚¹)

-  **`tag` ä¸å­˜åœ¨çš„æƒ…å†µ**

    å¾ˆç®€å•, `tag` å¦‚æœä¸å­˜åœ¨, ä¹Ÿå°±æ˜¯ä¸å­˜åœ¨æ ‡ç­¾çš„æƒ…å†µ, æ¯”å¦‚: `<p></p>` é‚£è‚¯å®šæ˜¯æ–‡æœ¬, æˆ–è€…æ³¨é‡Š, æ‰€ä»¥åœ¨è¿™ä¸ªå‡½æ•°æœ€åä¼šåˆ›å»ºè¿™ä¸¤ç§æ ‡ç­¾ å¹¶ä¸”é€šè¿‡ `insertå‡½æ•°` æ’å…¥åˆ° `parentElm` 

- **å†æ¥çœ‹çœ‹ `tag` å­˜åœ¨çš„æƒ…å†µ**

    1. é€šè¿‡ `nodeOps.createElement(tag, vnode)` åˆ›å»ºä¸€ä¸ªçœŸå®èŠ‚ç‚¹. (`nodeOps`æˆ‘ä»¬å°±çœ‹æˆ `window` å°±å¯ä»¥äº†, å®é™…ä¸Šä»–å°±æ˜¯å°è£…äº†ä¸€ä¸ªé’ˆå¯¹èŠ‚ç‚¹æ“ä½œçš„å·¥å…·ç®±.)

    2. æ‰§è¡Œ `createChildren(vnode, children, insertedVnodeQueue)` é€’å½’åˆ›å»ºå­èŠ‚ç‚¹

    3. æ‰§è¡Œ `insert(parentElm, vnode.elm, refElm)` æ’å…¥å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹

```js
function createElm (vnode, insertedVnodeQueue, parentElm, refElm, nested) {
    vnode.isRootInsert = !nested 
    if (createComponent(vnode, insertedVnodeQueue, parentElm, refElm)) {
      // å‰è™šæ‹ŸèŠ‚ç‚¹æ˜¯å¦å¯ä»¥ä½œä¸ºä¸€ä¸ªç»„ä»¶è¢«åˆ›å»º
      // ä½†è¿™æ˜¯ä¸‹ç¯‡çš„å†…å®¹, æˆ‘ä»¬å…ˆè·³è¿‡
      return
    }

    const data = vnode.data
    const children = vnode.children
    const tag = vnode.tag // tag å¯èƒ½æ˜¯ä¸€ä¸ªç»„ä»¶å¯¹è±¡
    // æ˜¯å¦æœ‰å®šä¹‰? 
    if (isDef(tag)) {
        vnode.elm  = nodeOps.createElement(tag, vnode)

        // åˆ›å»ºå­èŠ‚ç‚¹, å†…éƒ¨é€’å½’è°ƒç”¨äº† createElm
        createChildren(vnode, children, insertedVnodeQueue) // ğŸ‘ˆ
        insert(parentElm, vnode.elm, refElm)
 
    } else if (isTrue(vnode.isComment)) {
      vnode.elm = nodeOps.createComment(vnode.text)
      insert(parentElm, vnode.elm, refElm)
    } else {
      vnode.elm = nodeOps.createTextNode(vnode.text)
      insert(parentElm, vnode.elm, refElm)
    }
  }

```
- `createElm()` æ‰§è¡Œæµç¨‹

![æˆªå±2021-12-23 ä¸Šåˆ9.40.11.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9538e39a9e949aca149a34c425ecfc9~tplv-k3u1fbpfcp-watermark.image?)


---

**æ¥ä¸‹æ¥æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹`createChildren`**
> `createChildren`å‡½æ•°ä¸»è¦çš„ä½œç”¨å°±æ˜¯**é€’å½’åˆ›å»ºå­èŠ‚ç‚¹**, å¯ä»¥ä»”ç»†çœ‹ä¸Šå›¾çš„æµç¨‹ğŸ‘†
```js
  function createChildren (vnode, children, insertedVnodeQueue) {
    if (Array.isArray(children)) {
      for (let i = 0; i < children.length; ++i) {
        // åˆ›å»ºæ‰€æœ‰å­èŠ‚ç‚¹
        createElm(children[i], insertedVnodeQueue, vnode.elm, null, true)
      }
    } else if (isPrimitive(vnode.text)) {
      nodeOps.appendChild(vnode.elm, nodeOps.createTextNode(vnode.text))
    }
  }
```
**åœ¨`createChildren()` æ‰§è¡Œå®Œæ¯•åå°±ä¼šæ‰§è¡Œ `insert()` è´Ÿè´£å°†èŠ‚ç‚¹æ’å…¥åˆ°çˆ¶å…ƒç´ ä¸­.**

```js
  function insert (parent, elm, ref) {
    if (isDef(parent)) {
      if (isDef(ref)) {
        // refå…ƒç´  å­˜åœ¨çš„è¯, å°±å°†å…¶æ’å…¥åˆ° refå…ƒç´  ä¹‹å‰
        // è¿™ä¸ªå…ƒç´ æ˜¯çœŸå®èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªçœŸå®å…„å¼ŸèŠ‚ç‚¹
        // æˆ‘çŒœè¿™ä¹ˆåš, æ’å…¥ä½ç½®ä¼šæ›´å‡†ç¡®?
        if (nodeOps.parentNode(ref) === parent) {
          nodeOps.insertBefore(parent, elm, ref)
        }
      } else {
        // å¦åˆ™æ˜¯ç›´æ¥æ·»åŠ åˆ° çˆ¶å…ƒç´ ä¸‹
        nodeOps.appendChild(parent, elm)
      }
    }
  }
```
å¥½äº†, åˆ°è¿™é‡ŒèŠ‚ç‚¹çš„ç”Ÿæˆå°±ç®—æ˜¯ç»“æŸäº†. ä½†æ˜¯è¯·æ³¨æ„: 

`createChildren()` çš„æ‰§è¡Œæ˜¯åœ¨ `insert()`, ä¹‹å‰åˆ™æ„å‘³ç€, å­èŠ‚ç‚¹çš„`createElm()`å®Œæ¯•åæ‰ä¼šè¿›è¡Œå½“å‰èŠ‚ç‚¹çš„æ’å…¥. æ‰€ä»¥ä»–ä»¬çš„æ’å…¥é¡ºåºåº”è¯¥æ˜¯è¿™æ ·çš„:

**å½“å‰èŠ‚ç‚¹åˆ›å»º => åˆ›å»ºå­èŠ‚ç‚¹ => å­èŠ‚ç‚¹æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹ => å½“å‰èŠ‚ç‚¹æ’å…¥åˆ°å®ƒçš„çˆ¶èŠ‚ç‚¹**


> å½“ç„¶è¿™æ˜¯é€’å½’è°ƒç”¨çš„ç‰¹æ€§, å®é™…ä¸Š**Vueçš„ç»„ä»¶**ä¹Ÿæ˜¯è¿™æ ·çš„ç‰¹æ€§, ä»è€Œè§„å®šäº†ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œé¡ºåº. è¯·åŠ¡å¿…ç†è§£è¿™ä¸€ç‚¹, å¯¹äºåç»­ç†è§£ç»„ä»¶çš„æŒ‚è½½æœ‰ç›Š.

---

## æ—§èŠ‚ç‚¹çš„å¸è½½
åœ¨ `patch()` å‡½æ•°çš„æœ€åä¸€æ­¥, æœ‰ä¸€ä¸²è¿™æ ·çš„ä»£ç : 

```js
// ğŸ‘‡ åˆ é™¤æ—§èŠ‚ç‚¹
if (isDef(parentElm)) {
  removeVnodes([oldVnode], 0, 0)
} else if (isDef(oldVnode.tag)) {
  invokeDestroyHook(oldVnode)
}
```
> `removeVnodes` å†…éƒ¨å°±æ˜¯æ‰§è¡Œäº†èŠ‚ç‚¹çš„ç§»é™¤. ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆå‘¢, å¦‚æœæ‰“æ–­ç‚¹ä½ å°±ä¼šå‘ç°, åœ¨`createElm()`æ‰§è¡Œå, ä¼šæœ‰ä¸¤ä¸ªèŠ‚ç‚¹å­˜åœ¨. éšåè¿™æ®µä»£ç æ‰§è¡Œ, æ‰ä¼šæ¶ˆå¤±

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª`demo`
```js
 <div id="app" ref="app">{{ msg }}</div>
 
 new Vue({
    el: '#app',
    data:{
      msg: 'parent-Vue'
    },
  })
```
ç„¶ååœ¨`createElm()`å‰æ‰“ä¸€ä¸ªæ–­ç‚¹, å½“`createElmæ‰§è¡Œå®Œæ¯•å`, ä½†æ˜¯æ—§èŠ‚ç‚¹å¸è½½è¿˜æ²¡æ‰§è¡Œå‰, å°±ä¼šå‡ºç°ğŸ‘‡è¿™ç§æƒ…å†µ

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87b2847ed3b64db58f0f8d02558e5c25~tplv-k3u1fbpfcp-watermark.image?)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44b1562c27ee473db5bb5ddc6509858c~tplv-k3u1fbpfcp-watermark.image?)

